{% extends "base.html" %} {% block content %}
<div class="container mt-5">
  <h2>SightSeekAI旅游助手</h2>
  <div class="chat-container">
    <div
      id="chat-messages"
      class="mb-3 p-3 border rounded"
      style="height: 400px; overflow-y: auto"
    ></div>
    <div class="input-group">
      <input
        type="text"
        id="user-input"
        class="form-control"
        placeholder="输入您的问题..."
      />
      <button id="send-btn" class="btn btn-primary">发送</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const chatMessages = document.getElementById("chat-messages");
    const userInput = document.getElementById("user-input");
    const sendBtn = document.getElementById("send-btn");

    function addMessage(role, content) {
      const messageDiv = document.createElement("div");
      messageDiv.className = `message ${role}`;
      const header = `<strong>${role === "user" ? "您" : "AI助手"}:</strong>`;
      const body = role === "assistant" ? marked.parse(content) : content;
      messageDiv.innerHTML = `${header}<div class="message-content">${body}</div>`;
      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    sendBtn.addEventListener("click", async function () {
      const message = userInput.value.trim();
      if (!message) return;

      addMessage("user", message);
      userInput.value = "";

      try {
        const response = await fetch(
          "https://api.deepseek.com/v1/chat/completions",
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: "Bearer sk-1874ba502a56430aa4b5a858a2a2ed57",
            },
            body: JSON.stringify({
              model: "deepseek-chat",
              messages: [
                {
                  role: "system",
                  content: "你是一个专业的旅游助手，帮助用户解答旅游相关问题",
                },
                {
                  role: "user",
                  content: message,
                },
              ],
              temperature: 0.7,
            }),
          }
        );

        const data = await response.json();
        if (data.choices && data.choices[0].message) {
          addMessage("assistant", data.choices[0].message.content);
        } else {
          addMessage(
            "assistant",
            "抱歉，未能获取有效回复:\n" + JSON.stringify(data, null, 2)
          );
        }
      } catch (error) {
        addMessage("assistant", "抱歉，发生错误:\n" + error.message);
      }
    });

    userInput.addEventListener("keypress", function (e) {
      if (e.key === "Enter") {
        sendBtn.click();
      }
    });
  });
</script>

<style>
  .message {
    margin-bottom: 10px;
    padding: 8px 12px;
    border-radius: 5px;
  }
  .user {
    background-color: #e3f2fd;
    text-align: right;
  }
  .assistant {
    background-color: #f5f5f5;
    text-align: left;
  }
  .message-content {
    margin-top: 5px;
  }
  .message-content p {
    margin: 5px 0;
  }
  .message-content pre {
    background-color: #f8f9fa;
    padding: 10px;
    border-radius: 5px;
    overflow-x: auto;
  }
  .message-content code {
    background-color: #f8f9fa;
    padding: 2px 4px;
    border-radius: 3px;
    font-family: monospace;
  }
  .message-content ul,
  .message-content ol {
    padding-left: 20px;
    margin: 5px 0;
  }
  .message-content h1,
  .message-content h2,
  .message-content h3 {
    margin: 10px 0 5px 0;
  }
</style>
{% endblock %}
