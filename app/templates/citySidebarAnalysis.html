{% extends 'base.html' %}

{% block title %}城市景点分析{% endblock %}

{% block sidebar %}
  {{ block.super }}
{% endblock %}

{% block content %}
<div class="pagetitle" style="display: flex;align-items: center">
  <div style="margin-right: auto; display: flex; align-items: center; gap: 10px">
    <h1 style="margin: 0">城市景点分析</h1>
    <svg width="24" height="24" viewBox="0 0 24 24" fill="#4154f1" xmlns="http://www.w3.org/2000/svg">
      <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
    </svg>
    <nav>
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'home' %}">首页</a></li>
        <li class="breadcrumb-item active">城市景点分析</li>
      </ol>
    </nav>
  </div>
  <h5 style="font-weight: normal">
    {{ nowTime.year }} - {{ nowTime.mon }} - {{ nowTime.day }}
  </h5>
</div>

<section class="section">
  <div class="row">
    <div class="col-lg-12">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">城市选择</h5>
          <div class="alert alert-info mb-3" id="citySelectionAlert">
            当前选择: <span id="currentProvince">{% if provinceList %}{{ provinceList.0 }}{% else %}{% endif %}</span> <span id="currentCity">{{ selectedCity }}</span>
          </div>
          <script>
            // 初始化时从localStorage加载保存的选择或使用默认值
            document.addEventListener('DOMContentLoaded', function() {
              const provinceSelect = document.getElementById('provinceSelect');
              const citySelect = document.getElementById('citySelect');
              
              // 从localStorage获取保存的选择
              const savedProvince = localStorage.getItem('selectedProvince');
              const savedCity = localStorage.getItem('selectedCity');
              
              if (savedProvince && savedCity) {
                // 设置省份选择
                provinceSelect.value = savedProvince;
                document.getElementById('currentProvince').textContent = savedProvince;
                
                // 获取该省份下的城市列表
                fetch(`/app/get_cities?province=${encodeURIComponent(savedProvince)}`)
                  .then(response => response.json())
                  .then(cities => {
                    citySelect.innerHTML = '';
                    cities.forEach(city => {
                      const option = document.createElement('option');
                      option.value = city;
                      option.textContent = city;
                      citySelect.appendChild(option);
                    });
                    
                    // 设置城市选择
                    if (cities.includes(savedCity)) {
                      citySelect.value = savedCity;
                      document.getElementById('currentCity').textContent = savedCity;
                    } else {
                      citySelect.value = cities[0];
                      document.getElementById('currentCity').textContent = cities[0];
                    }
                  });
              } else {
                // 使用默认值
                document.getElementById('currentProvince').textContent = provinceSelect.value;
                document.getElementById('currentCity').textContent = citySelect.value;
              }
            });
          </script>
          <div class="row mb-3">
            <div class="col-sm-12">
              <div class="row align-items-center mb-3">
                <div class="col-md-4">
                  <div class="input-group mb-3">
                    <span class="input-group-text">省份</span>
                    <select id="provinceSelect" class="form-select">
                      {% for province in provinceList %}
                        <option value="{{ province }}">{{ province }}</option>
                      {% endfor %}
                    </select>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="input-group mb-3">
                    <span class="input-group-text">城市/风景区</span>
                    <select id="citySelect" name="city" class="form-select">
                      {% for city in cityList %}
                        <option value="{{ city }}" {% if city == selectedCity or not selectedCity and city == '澳门' %}selected{% endif %}>{{ city }}</option>
                      {% endfor %}
                    </select>
                  </div>
                </div>
              </div>
              
              <script>
                document.getElementById('provinceSelect').addEventListener('change', function() {
                  const province = this.value;
                  document.getElementById('currentProvince').textContent = province;
                  fetch(`/app/get_cities?province=${encodeURIComponent(province)}`)
                    .then(response => response.json())
                    .then(cities => {
                      const citySelect = document.getElementById('citySelect');
                      citySelect.innerHTML = '';
                      cities.forEach(city => {
                        const option = document.createElement('option');
                        option.value = city;
                        option.textContent = city;
                        citySelect.appendChild(option);
                      });
                      // 更新当前城市显示
                      document.getElementById('currentCity').textContent = cities[0];
                    });
                });
                
                document.getElementById('citySelect').addEventListener('change', function() {
                  document.getElementById('currentCity').textContent = this.value;
                });
              </script>
            </div>
          </div>
          <div class="row mt-3">
            <div class="col-12 text-center">
              <button id="confirmCityBtn" class="btn btn-primary mx-auto" style="width: 120px;">确定</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <script>
      document.getElementById('confirmCityBtn').addEventListener('click', function() {
        const province = document.getElementById('provinceSelect').value;
        const city = document.getElementById('citySelect').value;
        
        // 保存选择到localStorage
        localStorage.setItem('selectedProvince', province);
        localStorage.setItem('selectedCity', city);
        
        // 跳转到相应页面
        window.location.href = `/app/citySidebarAnalysis?city=${encodeURIComponent(city)}`;
      });
    </script>
  </div>


  <div class="row">
    <!-- 星级占比图表 -->
    <div class="col-lg-6">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">{{ selectedCity }} 景点星级占比</h5>
          <div id="starRatioChart" style="width:100%;height:400px"></div>
        </div>
      </div>
    </div>

    <!-- 价格分析图表 -->
    <div class="col-lg-6">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">{{ selectedCity }} 景点价格分析</h5>
          <div id="priceAnalysisChart" style="width:100%;height:400px"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- 词云图 -->
  <div class="row">
    <div class="col-lg-6">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">{{ selectedCity }} 景点词云</h5>
          <div id="wordCloudChart" style="width:100%;height:400px"></div>
        </div>
      </div>
    </div>
    <div class="col-lg-6">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">{{ selectedCity }} 游客评价词云</h5>
          <div id="commentCloudChart" style="width:100%;height:400px"></div>
        </div>
      </div>
    </div>
  </div>


  
  <!-- 景点列表 -->
  <div class="row">
    <div class="col-12">
      <div class="card recent-sales overflow-auto">
        <div class="card-body">
          <h5 class="card-title">{{ selectedCity }} 景点列表</h5>

              <table class="table table-borderless datatable">
            <thead>
              <tr>
                <th style="width:100px" scope="col">图片</th>
                <th scope="col">景区名</th>
                <th style="width:100px" scope="col">景区等级</th>
                <th style="width:100px" scope="col">景区评分</th>
                <th style="width:100px" scope="col">价格</th>
              </tr>
            </thead>
            <tbody>
              {% for i in travelList %}
                <tr onclick="window.location.href='/app/travelDetail/{{ i.id }}/'" style="cursor:pointer">
                  <th scope="row">
                    {% if i.image_url %}
                      <img src="{{ i.image_url }}" style="width:80px;height:60px;object-fit:cover" alt="{{ i.name }}">
                    {% else %}
                      <span>无图片</span>
                    {% endif %}
                  </th>
                  <td>{{ i.name }}</td>
                  <td><a href="#" class="text-primary">{% if i.grade %}{{ i.grade }}{% else %}无评级{% endif %}</a></td>
                  <td><span class="badge bg-success">{{ i.score }}分</span></td>
                  <td><span class="text-danger">${{ i.ticket_price }}</span></td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
(function() {
    // 等待所有资源加载完成
    function initWordClouds() {
        // 景点词云
        try {
            const wordCloudChart = echarts.init(document.getElementById('wordCloudChart'));
            const wordCloudOption = {
                title: {
                    text: '景点词云 - 大小表示综合热度',
                    left: 'center'
                },
                tooltip: {
                    show: true,
                    formatter: function(params) {
                        return params.name + ': ' + params.value.toFixed(1);
                    }
                },
                series: [{
                    type: 'wordCloud',
                    shape: 'circle',
                    left: 'center',
                    top: 'center',
                    width: '90%',
                    height: '90%',
                    sizeRange: [20, 80],
                    rotationRange: [-45, 45],
                    rotationStep: 15,
                    gridSize: 10,
                    drawOutOfBound: false,
                    textStyle: {
                        fontFamily: 'Microsoft YaHei',
                        fontWeight: 'bold',
                        color: function () {
                            return 'rgb(' + 
                                Math.round(Math.random() * 155 + 100) + ',' + 
                                Math.round(Math.random() * 155 + 100) + ',' + 
                                Math.round(Math.random() * 155 + 100) + ')';
                        }
                    },
                    emphasis: {
                        textStyle: {
                            shadowBlur: 10,
                            shadowColor: '#333'
                        }
                    },
                    data: {{ wordCloudData|safe }}
                }]
            };
            
            console.log('词云数据:', {{ wordCloudData|safe }});
            
            wordCloudChart.setOption(wordCloudOption);
            
            // 窗口大小变化时重绘
            window.addEventListener('resize', function() {
                wordCloudChart.resize();
            });
        } catch (error) {
            console.error('景点词云初始化失败:', error);
        }

        // 评论词云初始化
        try {
            const commentCloudChart = echarts.init(document.getElementById('commentCloudChart'));
            const commentCloudOption = {
                title: {
                    text: '游客评价词云',
                    left: 'center'
                },
                series: [{
                    type: 'wordCloud',
                    data: {{ commentCloudData|safe }}
                }]
            };
            commentCloudChart.setOption(commentCloudOption);
        } catch (error) {
            console.error('评论词云初始化失败:', error);
        }
    }

    // 多种方式确保执行
    if (document.readyState === 'complete') {
        initWordClouds();
    } else {
        window.addEventListener('load', initWordClouds);
        document.addEventListener('DOMContentLoaded', initWordClouds);
    }
})();
</script>
{% endblock %}

{% block echarts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  // 星级占比图表
  var starRatioChart = echarts.init(document.getElementById('starRatioChart'));
  var starRatioOption = {
    title: {
      text: '景点星级占比',
      left: 'center'
    },
    tooltip: {
      trigger: 'item'
    },
    legend: {
      orient: 'vertical',
      left: 'left'
    },
    series: [
      {
        name: '星级占比',
        type: 'pie',
        radius: '50%',
        data: {{ starRatioData | safe }},
        emphasis: {
          itemStyle: {
            shadowBlur: 10,
            shadowOffsetX: 0,
            shadowColor: 'rgba(0, 0, 0, 0.5)'
          }
        }
      }
    ]
  };
  starRatioChart.setOption(starRatioOption);
  // 价格分析图表
  var priceAnalysisChart = echarts.init(document.getElementById('priceAnalysisChart'));
  var priceAnalysisOption = {
    title: {
      text: '景点价格分析',
      left: 'center'
    },
    tooltip: {
      trigger: 'axis',
      axisPointer: {
        type: 'shadow'
      }
    },
    xAxis: {
      type: 'category',
      data: {{ priceAnalysisXData | safe }}
    },
    yAxis: {
      type: 'value'
    },
    series: [
      {
        name: '景点数量',
        type: 'bar',
        data: {{ priceAnalysisYData | safe }}
      }
    ]
  };
  priceAnalysisChart.setOption(priceAnalysisOption);
</script>
{% endblock %}
